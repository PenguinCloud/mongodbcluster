---
- name: Install required packages
  apt:
    name: 
      - software-properties-common
      - gnupg
      - apt-transport-https
      - ca-certificates
    state: present
    update_cache: true

- name: Fetch the MongoDB public GPG key
  get_url:
    url: "{{ mongodb.gpgkey }}"
    dest: "/opt/mongodb.gpg"

- name: Add the MongoDB public GPG key to the system
  shell: gpg --no-default-keyring --keyring /usr/share/keyrings/mongodb-server-{{ mongodb.version }}.gpg --import /opt/mongodb.gpg

- name: Remove temporary MongoDB public GPG key file
  file:
    path: "/opt/mongodb.gpg"
    state: absent

- name: Add the MongoDB repository
  ansible.builtin.lineinfile:
    path: /etc/apt/sources.list.d/mongodb-org-{{ mongodb.version }}.list
    line: 'deb [ arch=amd64,arm64 signed-by=/usr/share/keyrings/mongodb-server-{{ mongodb.version }}.gpg ] https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/{{ mongodb.version }} multiverse'
    create: true

- name: Update the package database
  ansible.builtin.apt:
    update_cache: true

- name: Install MongoDB
  ansible.builtin.apt:
    name: mongodb-org
    state: present
    update_cache: true

- name: Recursively change ownership of directory
  file:
    path: /var/lib/mongodb
    state: directory
    recurse: yes
    owner: "{{ run.user }}"
    group: "{{ run.user}}"


- name: Recursively change ownership of directory
  file:
    path: /opt/mongodb
    state: directory
    owner: "{{ run.user }}"
    group: "{{ run.user}}"

- name: Recursively change ownership of directory
  file:
    path: /var/log/mongodb
    state: directory
    recurse: yes
    owner: "{{ run.user }}"
    group: "{{ run.user}}"

- name: Create data directory 
  file:
    path: /data/db
    state: directory
    mode: '0755'
    owner: "{{ run.user }}"
    group: "{{ run.user}}"