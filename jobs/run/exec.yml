---
- name: Start mongodb
  shell: mongod --config /opt/mongodb/mongod.conf &

- name: Check MongoDB process
  shell: ps -ef | grep mongod | grep -v grep
  register: mongod_process
  changed_when: false
  retries: 5
  delay: 10
  until: mongod_process.rc == 0
  ignore_errors: true
  when: primary_cluster == "1"

- name: Display MongoDB status
  debug:
    msg: "MongoDB is {{ 'running' if mongod_process.stdout else 'not running' }}"
  when: primary_cluster == "1"

- name: Execute MongoDB Initialization
  block:
    - name: Run initialization task
      shell:
        cmd: mongosh --username "{{ mongodb.admin_username }}" --password "{{ mongodb.admin_password }}" --eval 'rs.initiate()'
      when: primary_cluster == "1"
      register: result
      until: result is success or retry_count >= 3
      retries: 3
      delay: 10
      vars:
        retry_count: 0

    - name: Handle failed task
      debug:
        msg: "Retrying the task"
      when: result is failed

  rescue:
    - name: Handle rescue scenario
      debug:
        msg: "Rescue scenario encountered"

- name: Add members using shell
  shell: >
    mongosh mongodb1:27017 -u "{{ mongodb.admin_username }}" -p "{{ mongodb.admin_password }}" \
    --eval "rs.add('{{ item | string }}')"
  loop: "{{ replica_set_members | string | split(',') }}"
  when: primary_cluster == "1"
  