---
- name: Start mongodb
  shell: mongod --config /opt/mongodb/mongod.conf &

- name: Check MongoDB process
  shell: ps -ef | grep mongod | grep -v grep
  register: mongod_process
  changed_when: false
  retries: 5
  delay: 10
  until: mongod_process.rc == 0
  ignore_errors: true

- name: Display MongoDB status
  debug:
    msg: "MongoDB is {{ 'running' if mongod_process.stdout else 'not running' }}"

- name: Create new admin user
  community.mongodb.mongodb_user:
    database: admin
    name: "{{ mongodb.admin_username }}"
    password: "{{ mongodb.admin_password }}"
    roles:
      - { role: "root", db: "admin" }
    state: present
    connection_options:
      - readPreference=primary
  when: primary_cluster == "1"

- name: Create a database
  shell:
    cmd: >
     mongosh --username "{{ mongodb.admin_username }}"
     --password "{{ mongodb.admin_password }}"
     --eval 'db.getSiblingDB("{{ mongodb.database_name }}").createCollection("dummy")'
  when: primary_cluster == "1"

- name: Find MongoDB process ID
  shell: "pgrep mongod"
  register: mongod_pid
  changed_when: false
  failed_when: mongod_pid.stdout == ""

- name: Stop MongoDB
  shell: "kill {{ mongod_pid.stdout }}"
  when: mongod_pid.stdout != ""

- name: Template the config file
  template:
    src: templates/mongod_conf.j2
    dest: /opt/mongodb/mongod.conf
    force: true
